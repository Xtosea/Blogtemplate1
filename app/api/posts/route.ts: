import { NextRequest, NextResponse } from "next/server";
import formidable from "formidable";
import fs from "fs";
import path from "path";

export const POST = async (req: NextRequest) => {
  const form = new formidable.IncomingForm();
  form.uploadDir = path.join(process.cwd(), "public/images");
  form.keepExtensions = true;
  form.multiples = true;

  return new Promise((resolve) => {
    form.parse(req, (err, fields, files: any) => {
      if (err) return resolve(NextResponse.json({ error: err.message }, { status: 500 }));

      const slug = (fields.slug as string) || (fields.title as string).toLowerCase().replace(/\s+/g, "-");
      const postPath = path.join(process.cwd(), `_posts/${slug}.md`);

      // Process uploaded images
      const uploadedImages = [];
      if (files.images) {
        const fileArray = Array.isArray(files.images) ? files.images : [files.images];
        for (const file of fileArray) {
          const filename = path.basename(file.filepath);
          uploadedImages.push("/images/" + filename);
        }
      }

      // Replace inline image placeholders in Markdown
      let mdContent = fields.content as string;
      uploadedImages.forEach((img, idx) => {
        mdContent = mdContent.replace(`![](image${idx + 1})`, `![](${img})`);
      });

      // Create Markdown frontmatter
      const finalContent = `---
title: "${fields.title}"
slug: "${slug}"
date: "${new Date().toISOString()}"
---

${mdContent}
`;

      fs.writeFileSync(postPath, finalContent);
      resolve(NextResponse.json({ success: true }));
    });
  });
};